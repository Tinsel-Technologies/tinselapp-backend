generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model ChatRoom {
  id           String    @id @default(cuid())
  participant1 String
  participant2 String
  isActive     Boolean   @default(true)
  createdAt    DateTime  @default(now())
  lastActivity DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  closedAt     DateTime?

  messages Message[]

  @@unique([participant1, participant2])
  @@map("chat_rooms")
}

model UserStatus {
  id        String   @id @default(cuid())
  userId    String   @unique
  isOnline  Boolean  @default(false)
  lastSeen  DateTime @default(now())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("user_status")
}

model MessageReadReceipt {
  id        String   @id @default(cuid())
  messageId String
  userId    String
  readAt    DateTime @default(now())
  createdAt DateTime @default(now())

  message Message @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@unique([messageId, userId])
  @@map("message_read_receipts")
}

model Message {
  id          String      @id @default(cuid())
  chatRoomId  String
  senderId    String
  message     String
  fileUrl     String?
  messageType MessageType @default(TEXT)
  isEdited    Boolean     @default(false)
  isDeleted   Boolean     @default(false)
  createdAt   DateTime    @default(now())
  editedAt    DateTime?
  updatedAt   DateTime    @updatedAt

  chatRoom ChatRoom @relation(fields: [chatRoomId], references: [id], onDelete: Cascade)

  repliedToId String?
  repliedTo   Message?  @relation("MessageReplies", fields: [repliedToId], references: [id], onDelete: NoAction)
  replies     Message[] @relation("MessageReplies")

  readReceipts  MessageReadReceipt[]
  contentCharge ContentCharge?

  @@map("messages")
}



model UserMonetizationSettings {
  id        String  @id @default(cuid())
  userId    String  @unique
  isEnabled Boolean @default(false)

  chatTimeTiers ChatTimeTier[]

  monetizeVoiceNotes Boolean @default(false)
  voiceNotePrice     Float   @default(0) 

  monetizeImages Boolean @default(false)
  imagePrice     Float   @default(0) 

  monetizeVideos Boolean @default(false)
  videoPrice     Float   @default(0) 

  currency  String   @default("KES")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("user_monetization_settings")
}

model ChatTimeTier {
  id         String @id @default(cuid())
  settingsId String

  durationMinutes Int 
  price           Float 

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  settings UserMonetizationSettings @relation(fields: [settingsId], references: [id], onDelete: Cascade)

  @@unique([settingsId, durationMinutes])
  @@index([settingsId])
  @@map("chat_time_tiers")
}

model ChatSession {
  id       String @id @default(cuid())
  buyerId  String
  sellerId String

  durationMinutes Int   
  price           Float
  currency        String @default("KES")

  startTime DateTime
  endTime   DateTime 

  usedMinutes    Float   @default(0) 
  isPaused       Boolean @default(false)
  lastActiveAt   DateTime? 
  pausedAt       DateTime? 
  resumedAt      DateTime? 

  isPaid Boolean   @default(false)
  paidAt DateTime?

  isActive    Boolean @default(true)
  isCancelled Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  contentCharges ContentCharge[]

  @@index([buyerId, isActive])
  @@index([sellerId, isActive])
  @@index([buyerId, sellerId, isActive])
  @@map("chat_sessions")
}

model ContentCharge {
  id          String      @id @default(cuid())
  messageId   String      @unique
  sessionId   String 
  senderId    String
  recipientId String
  contentType MessageType

  basePrice   Float 
  units       Float 
  totalAmount Float 

  isPaid Boolean   @default(false)
  paidAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  message Message     @relation(fields: [messageId], references: [id], onDelete: Cascade)
  session ChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([recipientId, isPaid])
  @@index([senderId, isPaid])
  @@index([sessionId])
  @@map("content_charges")
}

model UserBalance {
  id               String @id @default(cuid())
  userId           String @unique
  availableBalance Float  @default(0) 
  pendingBalance   Float  @default(0)
  totalEarnings    Float  @default(0)
  totalSpent       Float  @default(0) 

  currency    String   @default("KES")
  lastUpdated DateTime @default(now())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("user_balances")
}

model Payment {
  id                  String        @id @default(cuid())
  userId              String 
  merchantRequestId   String?       @unique
  checkoutRequestId   String?       @unique
  amount              Float
  phoneNumber         String
  accountReference    String
  transactionDesc     String
  status              PaymentStatus @default(PENDING)
  responseCode        String?
  responseDescription String?
  customerMessage     String?
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt

  callback PaymentCallback?

  @@index([userId]) 
  @@map("payments")
}

model PaymentCallback {
  id                 String   @id @default(cuid())
  paymentId          String   @unique
  merchantRequestId  String
  checkoutRequestId  String
  resultCode         Int
  resultDesc         String
  amount             Float?
  mpesaReceiptNumber String?
  transactionDate    String?
  phoneNumber        String?
  createdAt          DateTime @default(now())

  payment Payment @relation(fields: [paymentId], references: [id], onDelete: Cascade)

  @@map("payment_callbacks")
}

model B2CTransaction {
  id                            String              @id @default(cuid())
  userId                        String              // Clerk userId (admin/company user initiating payment)
  conversationId                String              @unique
  originatorConversationId      String
  amount                        Float
  phoneNumber                   String              // Recipient phone number
  remarks                       String
  occasion                      String
  commandID                     B2CCommandType      // SalaryPayment, BusinessPayment, PromotionPayment
  responseCode                  String
  responseDescription           String
  status                        B2CTransactionStatus @default(PENDING)
  
  resultCode                    Int?
  resultDesc                    String?
  transactionId                 String?             // M-Pesa transaction ID
  transactionReceipt            String?             // M-Pesa receipt number
  recipientRegistered           String?             // Whether recipient is registered
  charges                       Float?              // Transaction charges
  transactionCompletedDateTime  String?             // When transaction completed
  receiverPartyPublicName       String?             // Recipient name
  
  createdAt                     DateTime            @default(now())
  updatedAt                     DateTime            @updatedAt

  @@index([userId])
  @@index([conversationId])
  @@index([status])
  @@map("b2c_transactions")
}

model TransactionStatusQuery {
  id               String   @id @default(cuid())
  userId           String   
  transactionId    String  
  conversationId   String?
  queryResponse    Json?    
  status           String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([userId])
  @@index([transactionId])
  @@map("transaction_status_queries")
}

model AccountBalanceQuery {
  id               String   @id @default(cuid())
  userId           String  
  conversationId   String?
  workingBalance   Float?
  utilityBalance   Float?   
  chargesPaidBalance Float?
  unClearedBalance Float?
  queryResponse    Json?   
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([userId])
  @@map("account_balance_queries")
}

model ServiceRequest {
  id          String              @id @default(cuid())
  requesterId String             
  providerId  String             
  serviceType ServiceType
  duration    Int                 
  price       Float
  currency    String              @default("KES")
  status      ServiceRequestStatus @default(PENDING)
  message     String?           
  
  requestedAt DateTime            @default(now())
  respondedAt DateTime?
  
  sessionId   String?             @unique
  session     ServiceSession?
  
  notifications ServiceNotification[]
  
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt

  @@index([requesterId, status])
  @@index([providerId, status])
  @@index([status, createdAt])
  @@map("service_requests")
}

model ServiceNotification {
  id              String              @id @default(cuid())
  userId          String             
  requestId       String
  notificationType NotificationType
  isRead          Boolean             @default(false)
  readAt          DateTime?
  
  title           String
  message         String
  metadata        Json?               
  
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  
  request         ServiceRequest      @relation(fields: [requestId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
  @@index([requestId])
  @@map("service_notifications")
}

model ServiceSession {
  id          String              @id @default(cuid())
  requestId   String              @unique
  requesterId String
  providerId  String
  serviceType ServiceType
  
  duration    Int                
  price       Float
  currency    String              @default("KES")
  
  startTime   DateTime
  endTime     DateTime
  actualStart DateTime?
  actualEnd   DateTime?
  usedMinutes Float               @default(0)
  
  isActive    Boolean             @default(true)
  isPaused    Boolean             @default(false)
  isCompleted Boolean             @default(false)
  lastActiveAt DateTime?
  pausedAt    DateTime?
  resumedAt   DateTime?
  
  isPaid      Boolean             @default(false)
  paidAt      DateTime?
  
  connectionData Json?
  
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt
  
  request     ServiceRequest      @relation(fields: [requestId], references: [id], onDelete: Cascade)

  @@index([requesterId, isActive])
  @@index([providerId, isActive])
  @@index([isActive, serviceType])
  @@map("service_sessions")
}

model PendingBalance {
  id              String              @id @default(cuid())
  userId          String
  amount          Float
  currency        String              @default("KES")
  status          PendingBalanceStatus @default(LOCKED)
  
  sourceType      String              
  sourceId        String              
  
  lockedAt        DateTime            @default(now())
  releasedAt      DateTime?
  
  description     String?
  metadata        Json?
  
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  @@index([userId, status])
  @@index([sourceType, sourceId])
  @@index([status, createdAt])
  @@map("pending_balances")
}

model ServiceTransaction {
  id              String              @id @default(cuid())
  userId          String
  requestId       String?
  sessionId       String?
  transactionType ServiceTransactionType
  amount          Float
  currency        String              @default("KES")
  
  previousBalance Float
  newBalance      Float
  
  description     String
  metadata        Json?
  
  createdAt       DateTime            @default(now())

  @@index([userId, transactionType])
  @@index([requestId])
  @@index([sessionId])
  @@map("service_transactions")
}

enum ServiceType {
  CHAT
  VIDEO
  AUDIO
  IMAGE
}

enum ServiceRequestStatus {
  PENDING
  ACCEPTED
  REJECTED
  EXPIRED
  CANCELLED
  COMPLETED
}

enum NotificationType {
  SERVICE_REQUEST
  REQUEST_ACCEPTED
  REQUEST_REJECTED
  REQUEST_EXPIRED
  SESSION_STARTED
  SESSION_ENDING
  SESSION_ENDED
  PAYMENT_RECEIVED
  PAYMENT_PENDING
}

enum PendingBalanceStatus {
  LOCKED
  RELEASED
  EXPIRED
  REFUNDED
}

enum ServiceTransactionType {
  PAYMENT
  EARNING
  REFUND
  LOCK
  RELEASE
}

enum MessageType {
  TEXT
  IMAGE
  FILE
  VIDEO
  AUDIO
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  CANCELLED
}

enum B2CTransactionStatus {
  PENDING
  COMPLETED
  FAILED
  TIMEOUT
  CANCELLED
}

enum B2CCommandType {
  SalaryPayment
  BusinessPayment
  PromotionPayment
}